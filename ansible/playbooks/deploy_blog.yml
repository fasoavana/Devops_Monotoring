---
- name: DÃ©ploiement de l'application SmartShop
  hosts: web
  gather_facts: no
  vars:
    backend_port: 8000
    frontend_port: 3000
  
  tasks:
    - name: VÃ©rifier que le conteneur est accessible
      command: docker exec {{ inventory_hostname }} echo "OK"
      register: docker_check
      changed_when: false
      failed_when: docker_check.rc != 0

    - name: Afficher les conteneurs en cours
      command: docker ps
      register: docker_ps
      changed_when: false

    - name: Afficher l'Ã©tat des conteneurs
      debug:
        var: docker_ps.stdout_lines

    - name: VÃ©rifier que le backend rÃ©pond
      uri:
        url: "http://{{ inventory_hostname }}:{{ backend_port }}/api/health"
        method: GET
        status_code: 200
      register: backend_check
      ignore_errors: yes
      changed_when: false

    - name: Afficher le statut du backend
      debug:
        msg: "Backend: {{ 'âœ… OK' if backend_check.status == 200 else 'âŒ Indisponible' }}"

    - name: VÃ©rifier que le frontend rÃ©pond
      uri:
        url: "http://{{ inventory_hostname }}:{{ frontend_port }}"
        method: GET
        status_code: 200
      register: frontend_check
      ignore_errors: yes
      changed_when: false

    - name: Afficher le statut du frontend
      debug:
        msg: "Frontend: {{ 'âœ… OK' if frontend_check.status == 200 else 'âŒ Indisponible' }}"

- name: VÃ©rification de la stack monitoring
  hosts: monitoring
  connection: local
  gather_facts: no
  
  tasks:
    - name: VÃ©rifier Prometheus
      uri:
        url: "http://localhost:9090"
        method: GET
        status_code: 200
      register: prometheus_check
      ignore_errors: yes
      changed_when: false

    - name: Afficher statut Prometheus
      debug:
        msg: "Prometheus: {{ 'âœ… OK' if prometheus_check.status == 200 else 'âŒ Indisponible' }}"

    - name: VÃ©rifier Grafana
      uri:
        url: "http://localhost:3030"
        method: GET
        status_code: 200
      register: grafana_check
      ignore_errors: yes
      changed_when: false

    - name: Afficher statut Grafana
      debug:
        msg: "Grafana: {{ 'âœ… OK' if grafana_check.status == 200 else 'âŒ Indisponible' }}"

    - name: VÃ©rifier MySQL Exporter
      uri:
        url: "http://localhost:9104/metrics"
        method: GET
        status_code: 200
      register: exporter_check
      ignore_errors: yes
      changed_when: false

    - name: Afficher statut MySQL Exporter
      debug:
        msg: "MySQL Exporter: {{ 'âœ… OK' if exporter_check.status == 200 else 'âŒ Indisponible' }}"

    - name: RÃ©sumÃ© final
      debug:
        msg: 
          - "ğŸ‰ Infrastructure SmartShop dÃ©ployÃ©e !"
          - "ğŸ“Š Frontend: http://localhost:3000"
          - "ğŸ”Œ Backend API: http://localhost:8000"
          - "ğŸ“ˆ Prometheus: http://localhost:9090"
          - "ğŸ“‰ Grafana: http://localhost:3030 (admin/admin)"
          - ""
          - "ğŸ¤– Lancer le simulateur: docker exec -it blog-server-simule python /apps/backend/simulator.py"
